 - name: Collect only facts returned by facter
   hosts: all
   gather_facts: false  
  
   tasks:
     
     - name: Set static IP address
       win_shell: "(new-netipaddress -InterfaceAlias Ethernet -IPAddress {{ dc_address }} -prefixlength {{dc_netmask_cidr}} -defaultgateway {{ dc_gateway }})"
   
     - name: Set Password
       win_user:
         name: administrator
         password: "{{dc_password}}"
         state: present
         delegate_to: '{{ dc_address }}'
         ignore_errors: True  

     - name: Set upstream DNS server 
       win_dns_client:
           adapter_names: '*'
           ipv4_addresses:
           - '{{ upstream_dns_1 }}'
           - '{{ upstream_dns_2 }}'
           delegate_to: '{{ dc_address }}'

     - name: Stop the time service
       win_service:
        name: w32time
        state: stopped
        delegate_to: '{{ dc_address }}'

     - name: Set NTP Servers
       win_shell: 'w32tm /config /syncfromflags:manual /manualpeerlist:"{{ntp_servers}}"'
       delegate_to: '{{ dc_address }}'  

     - name: Start the time service
       win_service:
        name: w32time
        state: started  
        delegate_to: '{{ dc_address }}' 
    
     - name: Disable Domain firewall
       win_shell: "(Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled True)"
       delegate_to: '{{ dc_address }}'

